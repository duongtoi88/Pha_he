<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Xuất PDF Sơ đồ Phả hệ (A0)</title>
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: Arial; margin: 20px; }
    #tree-container {
      border: 1px solid #ccc;
      background: white;
      padding: 20px;
      width: 3370px; /* A0 width in px at 96dpi */
      height: 2384px; /* A0 height in px at 96dpi */
    }
    .node rect {
      rx: 10;
      ry: 10;
    }
    .dinh-x {
      fill: #c3e6cb;
      stroke: #155724;
    }
    .dinh-thuong {
      fill: #fff3cd;
      stroke: #856404;
    }
    .node text {
      font-size: 48px;
      text-anchor: middle;
      dominant-baseline: middle;
    }
    .btn-export {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      margin-bottom: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <button class="btn-export" onclick="downloadPDF()">⬇ Xuất PDF khổ A0</button>
  <div id="tree-container"></div>

  <script>
    function convertToTree(rows, rootID) {
      const people = {};
      rows.forEach(row => {
        const id = String(row.ID).replace('.0', '');
        people[id] = {
          id,
          name: row["Họ và tên"] || "",
          father: row["ID cha"] ? String(row["ID cha"]).replace('.0', '') : null,
          doi: row["Đời"] || "",
          dinh: row["Đinh"] || "",
          children: []
        };
      });
      Object.values(people).forEach(p => {
        if (p.father && people[p.father]) {
          people[p.father].children.push(p);
        }
      });
      return people[rootID];
    }

    function drawTree(data) {
      const root = d3.hierarchy(data);
      const treeLayout = d3.tree().nodeSize([200, 300]);
      treeLayout(root);

      const svg = d3.select("#tree-container").append("svg")
        .attr("width", 3370)
        .attr("height", 2384)
        .append("g")
        .attr("transform", "translate(100,100)");

      svg.selectAll(".link")
        .data(root.links())
        .enter().append("path")
        .attr("fill", "none")
        .attr("stroke", "#999")
        .attr("stroke-width", 2)
        .attr("d", d => `M${d.source.x},${d.source.y} V${(d.source.y + d.target.y)/2} H${d.target.x} V${d.target.y}`);

      const node = svg.selectAll(".node")
        .data(root.descendants())
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.x},${d.y})`);

      node.append("rect")
        .attr("x", -70).attr("y", -100)
        .attr("width", 140).attr("height", 200)
        .attr("class", d => d.data.dinh === "x" ? "dinh-x" : "dinh-thuong");

      node.append("text")
        .attr("x", 0).attr("y", 0)
        .text(d => d.data.name);
    }

    function downloadPDF() {
      const element = document.getElementById("tree-container");
      const opt = {
        margin: 0,
        filename: 'so_do_pha_he_A0.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 2 },
        jsPDF: {
          unit: 'px',
          format: [3370, 2384],
          orientation: 'landscape'
        }
      };
      html2pdf().set(opt).from(element).save();
    }

    fetch('input.xlsx')
      .then(res => res.arrayBuffer())
      .then(data => {
        const wb = XLSX.read(data, { type: 'array' });
        const sheet = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(sheet);
        const rootID = json.find(r => r["Đinh"] === "x")?.ID;
        if (rootID) {
          const tree = convertToTree(json, String(rootID).replace('.0', ''));
          drawTree(tree);
        }
      });
  </script>
</body>
</html>
